<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
  <title>Kraken Bot</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêô</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0f172a;
      --bg2: #1e293b;
      --bg3: #334155;
      --text: #f1f5f9;
      --text2: #94a3b8;
      --accent: #3b82f6;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
    }
    
    html {
      overflow-x: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      width: 100%;
    }
    
    .container {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
      overflow-x: hidden;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--bg3);
      margin-bottom: 20px;
    }
    
    h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
    h2 { font-size: 1rem; color: var(--text2); margin-bottom: 12px; }
    
    .balance {
      text-align: right;
    }
    .balance-amount {
      font-size: 2rem;
      font-weight: 700;
    }
    .balance-meta {
      color: var(--text2);
      font-size: 0.9rem;
    }
    
    .balance-header {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
    }
    .privacy-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .privacy-toggle-icon {
      font-size: 1.3rem;
      color: var(--text2);
    }
    .privacy-toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      background: #475569;
      border-radius: 10px;
      transition: background 0.2s;
    }
    .privacy-toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .privacy-toggle.active .privacy-toggle-switch {
      background: #3b82f6;
    }
    .privacy-toggle.active .privacy-toggle-switch::after {
      transform: translateX(16px);
    }
    .blurred {
      filter: blur(8px);
      user-select: none;
    }
    .chart-legend.hidden {
      visibility: hidden;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(400px, 100%), 1fr));
      gap: 20px;
      max-width: 100%;
    }
    
    .card {
      background: var(--bg2);
      border-radius: 12px;
      padding: 20px;
      max-width: 100%;
      overflow-x: auto;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.small { padding: 4px 8px; font-size: 0.8rem; }
    button.danger { background: var(--red); }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid var(--bg3);
    }
    th { color: var(--text2); font-weight: 500; font-size: 0.85rem; }
    td { font-size: 0.9rem; }
    
    .positive { color: var(--green); }
    .negative { color: var(--red); }
    .neutral { color: var(--yellow); }
    
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .tag.bullish { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .tag.bearish { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .tag.neutral { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }
    
    .analysis-text {
      color: var(--text2);
      line-height: 1.6;
      margin-bottom: 12px;
    }
    
    .commands {
      background: var(--bg);
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--accent);
      white-space: pre-wrap;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat {
      background: var(--bg2);
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .stat-label {
      color: var(--text2);
      font-size: 0.8rem;
      margin-top: 4px;
    }
    
    .logs {
      max-height: 300px;
      overflow-y: auto;
      background: var(--bg);
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.8rem;
      color: var(--text2);
    }
    .logs div { margin-bottom: 4px; }
    
    .table-scroll {
      max-height: 300px;
      overflow-y: auto;
      overflow-x: auto;
    }
    .table-scroll table {
      width: 100%;
      display: table;
    }
    .table-scroll thead th {
      position: sticky;
      top: 0;
      background: var(--bg2);
      z-index: 1;
    }
    .table-scroll tbody {
      display: table-row-group;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text2);
    }
    
    .chart-container {
      position: relative;
      height: 280px;
      width: 100%;
    }
    
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
      font-size: 0.85rem;
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text2);
    }
    
    .chart-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text2);
      font-size: 0.9rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
    }
    .status-dot.disconnected { background: var(--red); }
    
    /* Drag and drop styles */
    .card[draggable="true"] {
      cursor: grab;
    }
    .card[draggable="true"]:active {
      cursor: grabbing;
    }
    .card.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }
    .card.drag-over {
      border: 2px dashed var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }
    .card .drag-handle {
      cursor: grab;
      color: var(--text2);
      margin-right: 8px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    .card:hover .drag-handle {
      opacity: 1;
    }
    
    @media (max-width: 900px) {
      .container { padding: 12px; }
      .grid { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .card { padding: 14px; }
      h1 { font-size: 1.2rem; }
      .balance-amount { font-size: 1.5rem; }
      .chart-container { height: 220px; }
      table { font-size: 0.8rem; }
      th, td { padding: 6px 8px; }
      .chart-legend { gap: 12px; font-size: 0.75rem; }
    }
    
    @media (max-width: 500px) {
      .container { padding: 8px; }
      .stats { grid-template-columns: 1fr 1fr; gap: 8px; }
      .stat { padding: 10px; }
      .stat-value { font-size: 1.2rem; }
      .stat-label { font-size: 0.7rem; }
      header { flex-direction: column; gap: 12px; text-align: center; }
      .balance { text-align: center; }
      .balance-amount { font-size: 1.3rem; }
      .balance-meta { font-size: 0.8rem; }
      .card { padding: 12px; }
      .card-header { flex-direction: column; gap: 8px; align-items: flex-start; }
      .chart-container { height: 200px; }
      .chart-legend { flex-wrap: wrap; }
      .table-scroll { max-height: 250px; }
      .table-scroll table { white-space: nowrap; }
      th, td { padding: 5px 6px; font-size: 0.75rem; }
      .commands { font-size: 0.8rem; padding: 8px; }
      .analysis-text { font-size: 0.85rem; }
    }
    
    /* Asset Details Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: var(--bg2);
      border-radius: 12px;
      max-width: 800px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.2s;
    }
    .modal-overlay.active .modal {
      transform: scale(1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--bg3);
      position: sticky;
      top: 0;
      background: var(--bg2);
      z-index: 1;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: var(--text2);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
    }
    .modal-close:hover {
      color: var(--text);
    }
    .modal-body {
      padding: 20px;
    }
    .modal-section {
      margin-bottom: 24px;
    }
    .modal-section:last-child {
      margin-bottom: 0;
    }
    .modal-section h3 {
      font-size: 0.9rem;
      color: var(--text2);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .detail-item {
      background: var(--bg);
      padding: 12px;
      border-radius: 8px;
    }
    .detail-label {
      font-size: 0.75rem;
      color: var(--text2);
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 1rem;
      font-weight: 600;
    }
    .detail-value.large {
      font-size: 1.3rem;
    }
    .asset-link {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 2px;
    }
    .asset-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    .modal table {
      font-size: 0.85rem;
    }
    .modal th, .modal td {
      padding: 6px 10px;
    }
    .price-range {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .price-range-bar {
      flex: 1;
      height: 6px;
      background: var(--bg3);
      border-radius: 3px;
      position: relative;
    }
    .price-range-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: var(--bg3);
      border-radius: 3px;
    }
    .price-range-marker {
      position: absolute;
      top: -3px;
      width: 4px;
      height: 12px;
      background: var(--text);
      border-radius: 2px;
      transform: translateX(-50%);
    }
    .price-range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text2);
      margin-top: 4px;
    }
    @media (max-width: 600px) {
      .modal { width: 100%; max-height: 100vh; border-radius: 0; }
      .modal-header { padding: 16px; }
      .modal-body { padding: 16px; }
      .detail-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üêô Kraken Bot</h1>
        <div class="status">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Connecting...</span>
        </div>
      </div>
      <div class="balance">
        <div class="balance-header">
          <div class="privacy-toggle" id="privacyToggle" title="Toggle balance visibility">
            <span class="privacy-toggle-icon" id="privacyIcon">&#128065;</span>
            <div class="privacy-toggle-switch"></div>
          </div>
          <div class="balance-amount" id="balance">--</div>
        </div>
        <div class="balance-meta">
          Greed: <span id="greed">--</span> | 
          BTC: <span id="btcPrice">--</span>
        </div>
      </div>
    </header>
    
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="totalPnL">--</div>
        <div class="stat-label">Recent P&L</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="winRate">--</div>
        <div class="stat-label">Recent Win Rate</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="openOrders">--</div>
        <div class="stat-label">Open Orders</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="positions">--</div>
        <div class="stat-label">Positions</div>
      </div>
    </div>
    
    <!-- Portfolio Chart -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="card-header">
        <h2>Portfolio Value (7 Days)</h2>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <div class="chart-legend-color" style="background: #3b82f6;"></div>
            <span>EUR</span>
          </div>
          <div class="chart-legend-item">
            <div class="chart-legend-color" style="background: #f7931a;"></div>
            <span>BTC</span>
          </div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="portfolioChart"></canvas>
      </div>
      <div id="chartNoData" style="display: none; text-align: center; color: var(--text2); padding: 60px 0;">
        No historical data yet. Data will be collected hourly.
      </div>
    </div>
    
    <div class="grid" id="cardGrid">
      <!-- AI Analysis -->
      <div class="card" data-card-id="analysis" draggable="true">
        <div class="card-header">
          <h2><span class="drag-handle">&#9776;</span>AI Decision</h2>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div id="historyNav" style="display: none; align-items: center; gap: 4px;">
              <button class="small" onclick="historyPrev()" id="historyPrevBtn" title="Older">&larr;</button>
              <button class="small" onclick="historyNext()" id="historyNextBtn" title="Newer">&rarr;</button>
            </div>
            <button onclick="runAnalysis()" id="analyzeBtn">Run Analysis</button>
          </div>
        </div>
        <div id="analysisContent">
<p class="analysis-text">No decision yet. Click "Run Analysis" to start.</p>
        </div>
      </div>
      
      <!-- Positions -->
      <div class="card" data-card-id="positions" draggable="true">
        <div class="card-header">
          <h2><span class="drag-handle">&#9776;</span>Positions <span id="lastRefresh" style="font-size: 0.75rem; font-weight: normal; color: var(--text2);"></span></h2>
          <button onclick="refresh()" class="small" id="refreshBtn">Refresh</button>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr><th>Asset</th><th>Value</th><th>P&L</th><th>Days</th></tr>
            </thead>
            <tbody id="positionsTable">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Open Orders -->
      <div class="card" data-card-id="orders" draggable="true">
        <div class="card-header">
          <h2><span class="drag-handle">&#9776;</span>Open Orders</h2>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr><th>Type</th><th>Pair</th><th>Price</th><th>Vol</th></tr>
            </thead>
            <tbody id="ordersTable">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Recent Trades -->
      <div class="card" data-card-id="trades" draggable="true">
        <div class="card-header">
          <h2><span class="drag-handle">&#9776;</span>Recent Trades</h2>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr><th>Type</th><th>Pair</th><th>Cost</th><th>Time</th></tr>
            </thead>
            <tbody id="tradesTable">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Recent Closed Trades (Realized P&L) -->
      <div class="card" data-card-id="closedPnL" draggable="true">
        <div class="card-header">
          <h2><span class="drag-handle">&#9776;</span>Closed Trades P&L</h2>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr><th>Asset</th><th>P&L</th><th>%</th><th>Closed</th></tr>
            </thead>
            <tbody id="recentPnLTable">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Top Movers -->
      <div class="card" data-card-id="movers" draggable="true">
        <div class="card-header">
          <h2><span class="drag-handle">&#9776;</span>Top Movers (24h)</h2>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr><th>Pair</th><th>Price</th><th>Range</th><th>From Low</th></tr>
            </thead>
            <tbody id="moversTable">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Logs -->
      <div class="card" data-card-id="logs" draggable="true">
        <div class="card-header">
          <h2><span class="drag-handle">&#9776;</span>Logs</h2>
        </div>
        <div class="logs" id="logs">Loading...</div>
      </div>
    </div>
  </div>
    
    <!-- Asset Details Modal -->
    <div class="modal-overlay" id="assetModal" onclick="closeAssetModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 id="modalTitle">Asset Details</h2>
          <button class="modal-close" onclick="closeAssetModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>
  
  <script>
    let ws = null;
    let reconnectTimer = null;
    let analysisHistory = [];
    let historyIndex = 0; // 0 = latest (live), 1+ = older entries
    let portfolioChart = null;
    let privacyMode = localStorage.getItem('privacyMode') === 'true';
    
    // Privacy toggle functionality
    function initPrivacyToggle() {
      const toggle = document.getElementById('privacyToggle');
      const icon = document.getElementById('privacyIcon');
      
      // Apply saved state on load
      applyPrivacyMode();
      
      toggle.addEventListener('click', () => {
        privacyMode = !privacyMode;
        localStorage.setItem('privacyMode', privacyMode);
        applyPrivacyMode();
      });
    }
    
    function applyPrivacyMode() {
      const toggle = document.getElementById('privacyToggle');
      const icon = document.getElementById('privacyIcon');
      const balance = document.getElementById('balance');
      const chartLegend = document.querySelector('.chart-legend');
      
      if (privacyMode) {
        toggle.classList.add('active');
        balance.classList.add('blurred');
        if (chartLegend) chartLegend.classList.add('hidden');
        updateChartPrivacy(true);
      } else {
        toggle.classList.remove('active');
        balance.classList.remove('blurred');
        if (chartLegend) chartLegend.classList.remove('hidden');
        updateChartPrivacy(false);
      }
    }
    
    function updateChartPrivacy(hidden) {
      if (!portfolioChart) return;
      
      // Hide/show Y-axis tick labels
      portfolioChart.options.scales.y.ticks.display = !hidden;
      portfolioChart.options.scales.y1.ticks.display = !hidden;
      portfolioChart.options.scales.y.title.display = !hidden;
      portfolioChart.options.scales.y1.title.display = !hidden;
      
      // Hide tooltips when in privacy mode
      portfolioChart.options.plugins.tooltip.enabled = !hidden;
      
      portfolioChart.update();
    }
    
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);
      
      ws.onopen = () => {
        document.getElementById('statusDot').classList.remove('disconnected');
        document.getElementById('statusText').textContent = 'Connected';
        if (reconnectTimer) clearInterval(reconnectTimer);
      };
      
      ws.onclose = () => {
        document.getElementById('statusDot').classList.add('disconnected');
        document.getElementById('statusText').textContent = 'Disconnected - Reconnecting...';
        reconnectTimer = setTimeout(connect, 3000);
      };
      
      ws.onmessage = (e) => {
        const { type, data } = JSON.parse(e.data);
        
        if (type === 'state') {
          updateState(data);
          onRefreshComplete();
        }
        if (type === 'analysis') updateAnalysis(data, true); // Mark as live update
        if (type === 'orders') updateOrders(data);
      };
    }
    
    function updateState(data) {
      // Balance with BTC equivalent
      const balance = data.balance || 0;
      const btcPrice = data.ticker?.['XXBTZEUR']?.price;
      const btcEquiv = btcPrice ? (balance / btcPrice).toFixed(4) : '--';
      document.getElementById('balance').textContent = 
        balance.toFixed(2) + ' EUR (' + btcEquiv + ' BTC)';
      
      // Greed
      const greedEl = document.getElementById('greed');
      greedEl.textContent = `${data.greedClass || '--'} (${data.greedIndex || '--'}%)`;
      
      // BTC Price
      const btc = data.ticker?.['XXBTZEUR']?.price;
      document.getElementById('btcPrice').textContent = btc ? btc.toFixed(0) + ' EUR' : '--';
      
      // Stats (weekly)
      document.getElementById('totalPnL').textContent = 
        (data.analytics?.weeklyPnL || 0).toFixed(2) + ' EUR';
      document.getElementById('totalPnL').className = 
        'stat-value ' + ((data.analytics?.weeklyPnL || 0) >= 0 ? 'positive' : 'negative');
      
      document.getElementById('winRate').textContent = 
        (data.analytics?.weeklyWinRate || 0).toFixed(0) + '%';
      
      document.getElementById('openOrders').textContent = 
        Object.keys(data.orders || {}).length;
      
      document.getElementById('positions').textContent = 
        Object.keys(data.positions || {}).length;
      
      // Positions table
      updatePositions(data.positions);
      
      // Orders table
      updateOrders(data.orders);
      
      // Trades table
      updateTrades(data.trades);
      
      // Movers table
      updateMovers(data.ticker);
      
      // Recent closed trades P&L
      updateRecentPnL(data.recentPnL);
      
      // Analysis
      if (data.analysis) updateAnalysis(data.analysis);
    }
    
    function updatePositions(positions) {
      const tbody = document.getElementById('positionsTable');
      if (!positions || Object.keys(positions).length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color: var(--text2)">No positions</td></tr>';
        return;
      }
      
      tbody.innerHTML = Object.entries(positions)
        .sort((a, b) => b[1].currentValue - a[1].currentValue)
        .map(([asset, p]) => `
          <tr>
            <td><span class="asset-link" onclick="showAssetDetails('${asset}')">${asset.replace(/^[XZ]/, '')}</span></td>
            <td>${p.currentValue.toFixed(2)} EUR</td>
            <td class="${p.unrealizedPnL >= 0 ? 'positive' : 'negative'}">
              ${p.unrealizedPnL >= 0 ? '+' : ''}${p.unrealizedPnL.toFixed(2)} (${p.unrealizedPct.toFixed(1)}%)
            </td>
            <td>${p.holdingDays}d</td>
          </tr>
        `).join('');
    }
    
    function updateOrders(orders) {
      const tbody = document.getElementById('ordersTable');
      const orderList = Object.entries(orders || {});
      
      if (orderList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color: var(--text2)">No open orders</td></tr>';
        return;
      }
      
      tbody.innerHTML = orderList.map(([id, o]) => {
        const pair = o.descr?.pair || '';
        const asset = pair.replace(/EUR$/, '').replace(/^X+/, '');
        return `
          <tr>
            <td class="${o.descr?.type === 'buy' ? 'positive' : 'negative'}">${o.descr?.type?.toUpperCase()}</td>
            <td><span class="asset-link" onclick="showAssetDetails('${asset}')">${pair}</span></td>
            <td>${parseFloat(o.descr?.price).toFixed(2)}</td>
            <td>${parseFloat(o.vol).toFixed(4)}</td>
          </tr>
        `;
      }).join('');
    }
    
    function updateTrades(trades) {
      const tbody = document.getElementById('tradesTable');
      if (!trades || trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color: var(--text2)">No recent trades</td></tr>';
        return;
      }
      
      tbody.innerHTML = trades.map(t => {
        const asset = t.pair.replace(/Z?EUR$/, '').replace(/^X+/, '');
        return `
          <tr>
            <td class="${t.type === 'buy' ? 'positive' : 'negative'}">${t.type.toUpperCase()}</td>
            <td><span class="asset-link" onclick="showAssetDetails('${asset}')">${t.pair.replace('EUR', '')}</span></td>
            <td>${parseFloat(t.cost).toFixed(2)} EUR</td>
            <td>${new Date(t.time * 1000).toLocaleTimeString()}</td>
          </tr>
        `;
      }).join('');
    }
    
    function updateMovers(ticker) {
      const tbody = document.getElementById('moversTable');
      if (!ticker) return;
      
      const movers = Object.entries(ticker)
        .map(([pair, t]) => ({ pair, ...t }))
        .sort((a, b) => b.dayMove - a.dayMove);
      
      tbody.innerHTML = movers.map(m => {
        const asset = m.pair.replace(/Z?EUR$/, '').replace(/^X+/, '');
        return `
          <tr>
            <td><span class="asset-link" onclick="showAssetDetails('${asset}')">${m.pair.replace('EUR', '').replace(/^X+/, '')}</span></td>
            <td>${m.price < 1 ? m.price.toFixed(6) : m.price.toFixed(2)}</td>
            <td>${m.dayMove}%</td>
            <td class="${m.distFromLow < 30 ? 'positive' : m.distFromLow > 70 ? 'negative' : ''}">${m.distFromLow}%</td>
          </tr>
        `;
      }).join('');
    }
    
    function updateRecentPnL(recentPnL) {
      const tbody = document.getElementById('recentPnLTable');
      if (!recentPnL || recentPnL.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color: var(--text2)">No closed trades yet</td></tr>';
        return;
      }
      
      tbody.innerHTML = recentPnL.map(t => {
        const pnlClass = t.pnl >= 0 ? 'positive' : 'negative';
        const pnlSign = t.pnl >= 0 ? '+' : '';
        const pctSign = t.pnlPercent >= 0 ? '+' : '';
        const closedTime = new Date(t.sellTime * 1000);
        const now = new Date();
        const diffMs = now - closedTime;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const timeAgo = diffDays > 0 ? `${diffDays}d ago` : diffHours > 0 ? `${diffHours}h ago` : 'Just now';
        const cleanAsset = t.asset.replace(/^[XZ]/, '');
        
        return `
          <tr>
            <td><span class="asset-link" onclick="showAssetDetails('${t.asset}')">${cleanAsset}</span></td>
            <td class="${pnlClass}">${pnlSign}${t.pnl.toFixed(2)}</td>
            <td class="${pnlClass}">${pctSign}${t.pnlPercent.toFixed(1)}%</td>
            <td title="${closedTime.toLocaleString()}">${timeAgo}</td>
          </tr>
        `;
      }).join('');
    }
    
    function updateAnalysis(analysis, isLiveUpdate = false, isNavigation = false) {
      const container = document.getElementById('analysisContent');
      
      // If this is a live update (new analysis from server), add to history
      if (isLiveUpdate && analysis && analysis.lastUpdate) {
        // Add to front of history if it's new
        if (!analysisHistory.length || analysisHistory[0].lastUpdate !== analysis.lastUpdate) {
          const wasViewingLatest = historyIndex === 0;
          analysisHistory.unshift(analysis);
          // Keep only last 100
          if (analysisHistory.length > 100) analysisHistory = analysisHistory.slice(0, 100);
          
          // Only jump to latest if user was already viewing latest
          // Otherwise, increment index to keep viewing the same historical entry
          if (wasViewingLatest) {
            historyIndex = 0;
          } else {
            historyIndex++;
            updateHistoryNav(); // Update nav buttons but don't re-render content
            return; // Don't re-render, keep showing the historical entry user was reading
          }
        }
      }
      
      // If user is viewing a historical entry and this is just a state refresh (not live update or navigation),
      // don't re-render - keep showing what they're reading
      if (!isLiveUpdate && !isNavigation && historyIndex > 0) {
        return;
      }
      
      if (!analysis || !analysis.lastUpdate) {
        container.innerHTML = '<p class="analysis-text">No decision yet. Click "Run Analysis" to start.</p>';
        updateHistoryNav();
        return;
      }
      
      const time = new Date(analysis.lastUpdate).toLocaleString();
      const sentiment = analysis.marketSentiment || 'neutral';
      const isHistorical = historyIndex > 0;
      
      container.innerHTML = `
        <div style="margin-bottom: 12px;">
          <span class="tag ${sentiment}">${sentiment.toUpperCase()}</span>
          <span class="tag" style="background: var(--bg3); margin-left: 8px;">${analysis.riskAssessment || 'unknown'} risk</span>
          <span style="color: var(--text2); margin-left: 12px; font-size: 0.8rem;">${time}</span>
          ${isHistorical ? '<span style="color: var(--yellow); margin-left: 8px; font-size: 0.75rem;">(Historical)</span>' : ''}
        </div>
        <p class="analysis-text">${analysis.analysis || 'No rationale available.'}</p>
        <div class="commands">${analysis.commands || 'HOLD'}</div>
      `;
      
      updateHistoryNav();
    }
    
    function updateHistoryNav() {
      const nav = document.getElementById('historyNav');
      const prevBtn = document.getElementById('historyPrevBtn');
      const nextBtn = document.getElementById('historyNextBtn');
      
      if (analysisHistory.length <= 1) {
        nav.style.display = 'none';
        return;
      }
      
      nav.style.display = 'flex';
      prevBtn.disabled = historyIndex >= analysisHistory.length - 1;
      nextBtn.disabled = historyIndex <= 0;
    }
    
    function historyPrev() {
      if (historyIndex < analysisHistory.length - 1) {
        historyIndex++;
        updateAnalysis(analysisHistory[historyIndex], false, true);
      }
    }
    
    function historyNext() {
      if (historyIndex > 0) {
        historyIndex--;
        updateAnalysis(analysisHistory[historyIndex], false, true);
      }
    }
    
    async function runAnalysis() {
      const btn = document.getElementById('analyzeBtn');
      btn.disabled = true;
      btn.textContent = 'Running...';
      
      try {
        ws.send(JSON.stringify({ action: 'analyze' }));
      } catch (e) {
        console.error(e);
      }
      
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'Run Analysis';
      }, 5000);
    }
    
    let lastRefreshTime = null;
    
    async function refresh() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';
      
      try {
        ws.send(JSON.stringify({ action: 'refresh' }));
      } catch (e) {
        console.error(e);
      }
    }
    
    function onRefreshComplete() {
      lastRefreshTime = Date.now();
      const btn = document.getElementById('refreshBtn');
      btn.disabled = false;
      btn.textContent = 'Refresh';
      updateLastRefreshDisplay();
    }
    
    function updateLastRefreshDisplay() {
      const el = document.getElementById('lastRefresh');
      if (!lastRefreshTime) {
        el.textContent = '';
        return;
      }
      
      const seconds = Math.floor((Date.now() - lastRefreshTime) / 1000);
      if (seconds < 60) {
        el.textContent = `(${seconds}s ago)`;
      } else {
        const minutes = Math.floor(seconds / 60);
        el.textContent = `(${minutes}m ago)`;
      }
    }
    
    async function cancelOrder(orderId) {
      if (confirm('Cancel this order?')) {
        ws.send(JSON.stringify({ action: 'cancel', data: { orderId } }));
      }
    }
    
    // Fetch logs periodically
    async function fetchLogs() {
      try {
        const res = await fetch('/api/logs');
        const logs = await res.json();
        document.getElementById('logs').innerHTML = 
          logs.map(l => `<div>${l}</div>`).join('');
      } catch (e) {}
    }
    
    // Fetch analysis history on page load
    async function fetchHistory() {
      try {
        const res = await fetch('/api/history');
        const history = await res.json();
        if (history && history.length) {
          analysisHistory = history;
          historyIndex = 0;
          updateAnalysis(analysisHistory[0]);
        }
      } catch (e) {
        console.error('Failed to fetch history:', e);
      }
    }
    
    // Fetch and render portfolio chart
    async function fetchBalanceHistory() {
      try {
        const res = await fetch('/api/balance-history');
        const history = await res.json();
        renderPortfolioChart(history);
      } catch (e) {
        console.error('Failed to fetch balance history:', e);
      }
    }
    
    function renderPortfolioChart(history) {
      const canvas = document.getElementById('portfolioChart');
      const noDataEl = document.getElementById('chartNoData');
      
      if (!history || history.length === 0) {
        canvas.style.display = 'none';
        noDataEl.style.display = 'block';
        return;
      }
      
      canvas.style.display = 'block';
      noDataEl.style.display = 'none';
      
      // Prepare data
      const labels = history.map(h => new Date(h.timestamp));
      const eurData = history.map(h => h.balanceEUR);
      const btcData = history.map(h => h.balanceBTC);
      
      // Destroy existing chart if any
      if (portfolioChart) {
        portfolioChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      portfolioChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'EUR',
              data: eurData,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.3,
              pointRadius: history.length > 50 ? 0 : 3,
              pointHoverRadius: 5,
              yAxisID: 'y'
            },
            {
              label: 'BTC',
              data: btcData,
              borderColor: '#f7931a',
              backgroundColor: 'rgba(247, 147, 26, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              pointRadius: history.length > 50 ? 0 : 3,
              pointHoverRadius: 5,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#1e293b',
              titleColor: '#f1f5f9',
              bodyColor: '#94a3b8',
              borderColor: '#334155',
              borderWidth: 1,
              callbacks: {
                title: function(items) {
                  return new Date(items[0].parsed.x).toLocaleString();
                },
                label: function(context) {
                  if (context.dataset.label === 'EUR') {
                    return `EUR: ${context.parsed.y.toFixed(2)}`;
                  } else {
                    return `BTC: ${context.parsed.y.toFixed(6)}`;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'day',
                displayFormats: {
                  hour: 'MMM d, HH:mm',
                  day: 'MMM d'
                }
              },
              grid: {
                color: 'rgba(51, 65, 85, 0.5)'
              },
              ticks: {
                color: '#94a3b8',
                maxTicksLimit: 7
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'EUR',
                color: '#3b82f6'
              },
              grid: {
                color: 'rgba(51, 65, 85, 0.5)'
              },
              ticks: {
                color: '#3b82f6',
                callback: function(value) {
                  return value.toFixed(0);
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'BTC',
                color: '#f7931a'
              },
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                color: '#f7931a',
                callback: function(value) {
                  return value.toFixed(4);
                }
              }
            }
          }
        }
      });
      
      // Apply privacy mode to newly rendered chart
      if (privacyMode) {
        updateChartPrivacy(true);
      }
    }
    
    // Drag and drop functionality
    let draggedCard = null;
    
    function initDragAndDrop() {
      const grid = document.getElementById('cardGrid');
      const cards = grid.querySelectorAll('.card[draggable="true"]');
      
      cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('dragenter', handleDragEnter);
        card.addEventListener('dragleave', handleDragLeave);
        card.addEventListener('drop', handleDrop);
      });
    }
    
    function handleDragStart(e) {
      draggedCard = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.cardId);
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.card').forEach(card => {
        card.classList.remove('drag-over');
      });
      draggedCard = null;
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }
    
    function handleDragEnter(e) {
      e.preventDefault();
      if (this !== draggedCard) {
        this.classList.add('drag-over');
      }
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      if (draggedCard && this !== draggedCard) {
        const grid = document.getElementById('cardGrid');
        const cards = Array.from(grid.querySelectorAll('.card[draggable="true"]'));
        const draggedIndex = cards.indexOf(draggedCard);
        const targetIndex = cards.indexOf(this);
        
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedCard, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedCard, this);
        }
        
        saveCardOrder();
      }
    }
    
    function saveCardOrder() {
      const grid = document.getElementById('cardGrid');
      const cards = grid.querySelectorAll('.card[draggable="true"]');
      const order = Array.from(cards).map(card => card.dataset.cardId);
      localStorage.setItem('krakenBotCardOrder', JSON.stringify(order));
    }
    
    function restoreCardOrder() {
      const savedOrder = localStorage.getItem('krakenBotCardOrder');
      if (!savedOrder) return;
      
      try {
        const order = JSON.parse(savedOrder);
        const grid = document.getElementById('cardGrid');
        const cards = grid.querySelectorAll('.card[draggable="true"]');
        const cardMap = {};
        
        cards.forEach(card => {
          cardMap[card.dataset.cardId] = card;
        });
        
        // Reorder cards based on saved order
        order.forEach(cardId => {
          if (cardMap[cardId]) {
            grid.appendChild(cardMap[cardId]);
          }
        });
        
        // Append any new cards that weren't in the saved order
        cards.forEach(card => {
          if (!order.includes(card.dataset.cardId)) {
            grid.appendChild(card);
          }
        });
      } catch (e) {
        console.error('Failed to restore card order:', e);
      }
    }
    
    // ============================================
    // ASSET DETAILS MODAL
    // ============================================
    
    async function showAssetDetails(asset) {
      const modal = document.getElementById('assetModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      // Clean up asset name for display
      const cleanAsset = asset.replace(/^[XZ]+/, '').replace(/\.S$/, '');
      modalTitle.innerHTML = `<span>${cleanAsset}</span>`;
      modalBody.innerHTML = '<div class="loading">Loading asset details...</div>';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      try {
        const res = await fetch(`/api/asset-details?asset=${encodeURIComponent(asset)}`);
        const data = await res.json();
        renderAssetDetails(data);
      } catch (e) {
        modalBody.innerHTML = `<div class="loading" style="color: var(--red);">Failed to load asset details: ${e.message}</div>`;
      }
    }
    
    function closeAssetModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('assetModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAssetModal();
    });
    
    function renderAssetDetails(data) {
      const modalBody = document.getElementById('modalBody');
      const modalTitle = document.getElementById('modalTitle');
      
      if (!data || !data.asset) {
        modalBody.innerHTML = '<div class="loading">No data available for this asset.</div>';
        return;
      }
      
      // Update title with price if available
      if (data.ticker) {
        const priceStr = data.ticker.price < 1 ? data.ticker.price.toFixed(6) : data.ticker.price.toFixed(2);
        modalTitle.innerHTML = `<span>${data.asset}</span><span style="font-weight: normal; color: var(--text2); font-size: 1rem;">${priceStr} EUR</span>`;
      } else {
        modalTitle.innerHTML = `<span>${data.asset}</span>`;
      }
      
      let html = '';
      
      // Key Stats - most important info in one row
      const t = data.ticker;
      const p = data.position;
      const cb = data.costBasis;
      
      html += '<div class="modal-section"><div class="detail-grid">';
      
      // Current price & 24h position
      if (t) {
        html += `
          <div class="detail-item">
            <div class="detail-label">24h Range</div>
            <div class="detail-value">${t.distFromLow}% from low</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">24h Move</div>
            <div class="detail-value">${t.dayMove}%</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Spread</div>
            <div class="detail-value">${t.spreadPct.toFixed(2)}%</div>
          </div>
        `;
      }
      
      // Position info
      if (p) {
        const pnlClass = p.unrealizedPnL >= 0 ? 'positive' : 'negative';
        const pnlSign = p.unrealizedPnL >= 0 ? '+' : '';
        html += `
          <div class="detail-item">
            <div class="detail-label">Value</div>
            <div class="detail-value">${p.currentValue.toFixed(2)} EUR</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">P&L</div>
            <div class="detail-value ${pnlClass}">${pnlSign}${p.unrealizedPnL.toFixed(2)} (${pnlSign}${p.unrealizedPct.toFixed(1)}%)</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Avg Cost</div>
            <div class="detail-value">${p.avgCost < 1 ? p.avgCost.toFixed(6) : p.avgCost.toFixed(2)}</div>
          </div>
        `;
      }
      
      // Realized P&L if any
      if (cb && cb.realizedPnL !== 0) {
        const pnlClass = cb.realizedPnL >= 0 ? 'positive' : 'negative';
        const pnlSign = cb.realizedPnL >= 0 ? '+' : '';
        html += `
          <div class="detail-item">
            <div class="detail-label">Realized P&L</div>
            <div class="detail-value ${pnlClass}">${pnlSign}${cb.realizedPnL.toFixed(2)} EUR</div>
          </div>
        `;
      }
      
      html += '</div></div>';
      
      // Price range visualization
      if (t) {
        html += `
          <div class="modal-section">
            <div class="price-range">
              <span style="font-size: 0.75rem; color: var(--text2);">${t.low24 < 1 ? t.low24.toFixed(4) : t.low24.toFixed(2)}</span>
              <div class="price-range-bar">
                <div class="price-range-fill" style="width: 100%;"></div>
                <div class="price-range-marker" style="left: ${t.distFromLow}%;"></div>
              </div>
              <span style="font-size: 0.75rem; color: var(--text2);">${t.high24 < 1 ? t.high24.toFixed(4) : t.high24.toFixed(2)}</span>
            </div>
          </div>
        `;
      }
      
      // Open Orders - always important
      if (data.openOrders && data.openOrders.length > 0) {
        html += `
          <div class="modal-section">
            <h3>Open Orders</h3>
            <div class="table-scroll" style="max-height: 120px;">
              <table>
                <thead><tr><th>Type</th><th>Price</th><th>Volume</th></tr></thead>
                <tbody>
                  ${data.openOrders.map(o => `
                    <tr>
                      <td class="${o.type === 'buy' ? 'positive' : 'negative'}">${o.type?.toUpperCase()}</td>
                      <td>${o.price < 1 ? o.price.toFixed(6) : o.price.toFixed(2)}</td>
                      <td>${o.volume.toFixed(4)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      // Recent Trades - limited to 5
      if (data.recentTrades && data.recentTrades.length > 0) {
        html += `
          <div class="modal-section">
            <h3>Recent Trades</h3>
            <div class="table-scroll" style="max-height: 160px;">
              <table>
                <thead><tr><th>Type</th><th>Price</th><th>Cost</th><th>Date</th></tr></thead>
                <tbody>
                  ${data.recentTrades.slice(0, 5).map(t => `
                    <tr>
                      <td class="${t.type === 'buy' ? 'positive' : 'negative'}">${t.type.toUpperCase()}</td>
                      <td>${t.price < 1 ? t.price.toFixed(6) : t.price.toFixed(2)}</td>
                      <td>${t.cost.toFixed(2)}</td>
                      <td>${new Date(t.time * 1000).toLocaleDateString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      // If nothing to show
      if (html === '<div class="modal-section"><div class="detail-grid"></div></div>') {
        html = '<div class="loading">No trading data available for this asset.</div>';
      }
      
      modalBody.innerHTML = html;
    }
    
    // Initialize
    restoreCardOrder();
    initDragAndDrop();
    initPrivacyToggle();
    connect();
    fetchLogs();
    fetchHistory();
    fetchBalanceHistory();
    setInterval(fetchLogs, 10000);
    setInterval(fetchBalanceHistory, 60000); // Refresh chart every minute
    setInterval(updateLastRefreshDisplay, 5000); // Update "x ago" display
  </script>
</body>
</html>
